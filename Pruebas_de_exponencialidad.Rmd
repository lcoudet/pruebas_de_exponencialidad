---
title: "Pruebas de exponencialidad"
author: "Lucia Coudet - Daniel Czarnievicz"
date: "Octubre de 2018"
output:
  beamer_presentation:
    theme: "Frankfurt"
    colortheme: "default"
    fonttheme: "structurebold"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
library(kableExtra)
library(ggrepel)
```

# Análisis de supervivencia

- Métodos utilizados para el análisis de información donde la variable de resultado es el tiempo hasta la ocurrencia de un evento de interés.  
- Requiere de técnicas especiales dado que:
  1. La información suele seguir distribuciones asimétricas, por lo que la normalidad no es un supuesto razonable.  
  2. Algunas unidads muestrales pueden no haber llegado al fin del experimiento, por lo que se estaría en presencia de datos censurados.  

# Función de supervivencia

- Se define la **función de supervivencia** como la probabilidad de que el tiempo de supervivencia $T$ sea mayor a un tiempo $t$:

$$ S(t) = P(T \geq t)$$

- Ante presencia de datos censurados, la misma se estima mediante el estimador de Kaplan-Meier:

$$\hat{S}(t) = \prod\limits_{j / t_{(j)} \leq t} \left( 1 - \frac{d_j}{r_j} \right) $$
donde $d_j$ es el número de individuos que experimentaor el suceso de interés en el momento $t_{(j)}$, y $r_j$ es el número de individuos en riesgo inmediatamente antes del momento $t_{(j)}$.

# Función de riesgo

- El objetivo de la función de riesgo es estudiar qué períodos tienen mayor probabilidad de ocurrencia del suceso de interés.  
- Se define la **función de riesgo** como la probabilidad de que un individuo experimente el suceso de interés en un intervalo pequeño de tiempo, $s$, dado que ha sobrrrvivido hasta el inicio del intervalo, para cualquier intervalo cuya longitud tiende a cero:

$$h(t) = \lim\limits_{s \rightarrow 0} \frac{ P(t \leq T \leq t+s | T \geq t) }{ s } $$
donde $T$ son los tiempos de supervivencia de los individuos.

- Estimador de la función de riesgo:

$$\hat{h}(t) = \frac{d_j}{ n_j ( t_{(j+1)} - t_{(j)} ) } $$

# Tiempo de vida

- El complemento de la función de supervivencia es la **función de tiempo de vida**: $F(t) = P(T \leq t) = 1 - S(t)$.  
- Toda función para la cual $F(a) = 0 \,\,\, \forall a < 0$ es una distribución de vida.  
- Existen muchas clases de distribuciones de vida:
      - IFR: increasing failure rate.  
      - DFR: decreasing failure rate.  
      - NBU: new better than used.  
      - DMRL: decreasing mean residual life.  

# Tiempo de vida

- A su vez, existen muchas familias de distribución que pueden describir distintas clases de funciones de vida, dependiendo de su parametrización. Por ejemplo:

\begin{center}
      \begin{tabular}{| l | c | c | c |}
      \hline
                  & DFR          & CFR                      & IFR \\ 
      \hline
      \hline
      Exponencial &              & $\forall \lambda > 0$    &        \\ 
      \hline
      Weibull     & $\alpha < 1$ & Exponencial              & $\alpha > 1$ \\ 
      \hline
      Gamma       & $\alpha < 1$ & Exponencial              & $\alpha > 1$ \\ 
      \hline
      \end{tabular}
\end{center}

- Debido a estas relaciones es que el análisis de supervivencia está intimamente relacionado con las pruebas de exponencialidad. Los investigadores buscan estudiar cómo cambia la probabilidad de ocurrencia del evento de interés.

# Methylmercury Poisoning

Se quiere estudiar el efecto de la aplicación de dosis de metilmercurio (un veneno) en el tiempo de vida de los peces, los cuales fueron sometidos a varias dosis del veneno.

Al nivel de una dosis, se obtuvieron los siguientes \textbf{tiempos de vida hasta la muerte ordenados} (en días):

$$42, 43, 51, 61, 66, 69, 71, 81, 82, 82$$

# Definición: failure rate function r(x)

$$ r(x) = \frac{f(x)}{\bar{F}(x)} $$
en donde $\bar{F}(x) = 1 - F(x)$

## Interpretación

$r(x) \delta_x$ es la probabilidad de que un ítem (unidad, persona, parte) viva a la edad $x$ fallezca en el intervalo $(x, x + \delta_x)$ con $\delta_x$ pequeño. Si:

-  $r(x)$ creciente, entonces la tasa de fallecimiento crece conforme crece la edad.
-  $r(x)$ decreciente, entonces la tasa de fallecimiento decrece conforme a la edad.
-  $r(x)$ contante, entonces la tasa de fallecimiento ni crece ni decrece con la edad (independencia).

# Hipótesis nula de exponencialidad

$$ H_0: r(x)=\lambda $$
La hipótesis nula de exponencialidad implica suponer una \textbf{tasa constante}, es decir \textbf{\underline{independiente de la edad}}, el cual es el supuesto de la distribución exponencial. A veces se dice que la distribución exponencial \textit{no tiene memoria}, en el sentido que la edad no afecta la probabilidad de muerte.

Por lo tanto, podemos escribir la hipótesis nula como:

$$H_0: F(x) = (1 - e^{- \lambda x}) \text{I}_{[x \geq 0]}$$  
ó, 
$$H_0: \bar{F}(x) = e^{- \lambda x} \text{I}_{[x \geq 0]}$$

# Clases de distribuciones de vida

\textbf{\underline{Una distribución de vida $F$ es de la clase:}}

- \textbf{IFR (increasing failure rate)}, si $r(x)$ es estrictamente no decreciente.

- \textbf{DFR (decreasing failure rate)}, si $r(x)$ es estrictamente no creciente.

## Es decir:

- $r(x)$ es IFR si $r(x) \leq r(y) \, \forall \, x<y$.
- $r(x)$ es DFR si $r(x) \geq r(y) \, \forall \, x<y$.

# Prueba y estadistico de prueba

Sea $X_1, \ldots, X_n$ una muestra de $X$ y sean $X_{(1)}, \ldots, X_{(n)}$ los estadísticos de orden, con $X_{(0)}=0$. Se consideran los espacion normalizados $D_1, \ldots, D_n$:

$$ D_i = (n-i+1)(X_{(i)} - X_{(i-1)})$$

Entonces tenemos que:

$D_1 = nX_{(1)}$  
$D_2 = (n-1) (X_{(2)} - X_{(1)})$  
$D_3 = (n-2) (X_{(3)} - X_{(2)})$  
$\vdots$  
$D_n = 1(X_{(n)} - X_{(n-1)})$

# Estadístico de prueba

A partir del tiempo total en prueba al momento $X_i$:

$$S_i = \sum_{u=1}^i D_u \,\,\,\,\, i=1, \ldots, n$$
se define el estadístico de prueba de la siguiente manera:

$$\varepsilon = \frac{1}{S_n} \sum\limits_{i=1}^{n-1} S_i $$

<!--
# Interpretación del tiempo total en prueba al momento $X_{(i)}$

![](dibujito.png)
-->

# Interpretación del tiempo total en prueba al momento $X_{(i)}$

```{r, echo=FALSE}
ggplot() +
      # geom_point(data=data.frame(x=c(0,10,10,0), y=c(0,0,10,0)), aes(x,y)) +
      geom_line(data=data.frame(x=c(0, 10), y=c(10, 10)), aes(x,y), 
                arrow=arrow(), size=0.5) +
      geom_text(data=data.frame(x=11, y=10, lab="Tiempo"), aes(x,y,label=lab)) +
      geom_text(data=data.frame(x=c(2, 3, 4, 5, 6, 7, 8, 9), y=9.5,
            lab=c("X[1]", "X[2]", "X[3]", "ldots", "X[i-1]", "X[i]", "ldots", "X[n]")), 
            aes(x,y,label=lab), parse=TRUE) +
      geom_line(data=data.frame(x=c(2,2,3,3,4,4,6,6,7,7,9,9), y=rep(c(9.75,10.25), 6)),
                aes(x,y, group=x)) +
      geom_rect(data=data.frame(
            xmin=c(0,2,3,4,6,7),
            xmax=c(2,3,4,6,7,9),
            ymin=0,
            ymax=c(9,8,7,5,4,2)), 
            aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill="grey", color="black") +
      geom_line(data=data.frame(
            x=c(0,2,0,3,0,4,0,6,0,7,0,9),
            y=c(9,9,8,8,7,7,5,5,4,4,2,2)),
            aes(x,y, group=y), arrow=arrow(), size=0.75, color="red") +
      geom_text(data=data.frame(
            x=-1,
            y=c(-1,-2,-3,-4.5,-6,-7,-8),
            lab=c("S[1]","S[2]","S[3]","cdots","S[i]","cdots","S[n]")),
            aes(x,y,label=lab), parse=TRUE) +
      geom_text(data=data.frame(
            x=-.70,
            y=c(-1,-2,-3,-4,-6,-7,-8),
            lab=c("=","=","=","","=","","=")),
            aes(x=x, y=y+0.1, label=lab), parse=FALSE) +
      geom_text(data=data.frame(
            x=c( 1,  2.5, 3.5,  5,  6.5,  7.5,  8.5),
            y=c(-1, -2,  -3,   -4.5, -6, -7, -8),
            lab=c("n * X[1]","(n-1)*(X[2]-X[1])","(n-2)*(X[3]-X[2])","cdots",
                  "(n-i+1)*(X[i]-X[i-1])","cdots","(1)*(X[n]-X[n-1])")),
            aes(x, y, label=lab), parse=TRUE) +
      geom_text(data=data.frame(
            x=c( 2, 3, 4, 6,   7, 8),
            y=c(-1,-2,-3,-4.5,-6,-7),
            lab=c("+")),
            aes(x=x, y=y-0.5, label=lab), parse=FALSE) +
      labs(x=NULL, y=NULL) +
      theme_void()
```

# Test a una cola con alternativa IFR

-  $H_0: F$ es exponencial 

-  $H_1: F$ es IFR (y por lo tanto no exponencial)

\textbf{\underline{Zona de rechazo}}

$\epsilon \geq e_{\alpha}$

Con $\alpha$ tal que $P(\epsilon \geq e_{\alpha}) = \alpha$

# Test a una cola con alternativa DFR

-  $H_0: F$ es exponencial

-  $H_1: F$ es DFR (y por lo tanto no exponencial)


\textbf{\underline{Zona de rechazo}}

$\epsilon \leq \frac{n-1}{2} - e_{\alpha}$

# Test a dos colas con alternativa IFR o DFR

-  $H_0: F$ es exponencial 

-  $H_1: F$ es IFR o DFR (y por lo tanto no exponencial)

\textbf{\underline{Zona de rechazo}}: 

-  $\epsilon \geq e_{\frac{\alpha}{2}}$
-  $\epsilon \leq \frac{n-1}{2} - e_{\frac{\alpha}{2}}$

# Aproximación para muestras grandes

Se había definido al estadístico de prueba $\epsilon$ como:
$$\epsilon = \frac{1}{S_n} \sum\limits_{i=1}^{n-1} S_i$$

Ahora bien, es posible expresarlo en función de $T_1, \cdots, T_n$ dónde:
$$T_i = \frac{S_i}{S_n} = \frac{\sum_{u=1}^i D_u}{\sum_{u=1}^n D_u}$$

Entonces:
$$\epsilon = \sum_{i=1}^{n-1} T_i$$

Los cual bajo la hipótesis nula de exoinencialidad corresponde a una suma de VA $U(0,1)$ iid (ver Epstein, 1960) y por lo tanto: $E_0(\epsilon) = \frac{n-1}{2}$ y $V_0(\epsilon) = \frac{n-1}{12}$.

# Aproximación para muestras grandes

Sea entonces $\epsilon^{*} = \frac{\epsilon - E_0(\epsilon)}{\sqrt{V_0(\epsilon)}} = \frac{\epsilon - \frac{n-1}{2}}{\sqrt{\frac{n-1}{12}}}$.

Aplicando el TLC se cumple que:

$$ \epsilon^{*} \overset{n \to \infty}{\to} N(0,1) $$


\textbf{\underline{Zonas de rechazo para muestras grandes}}:

- Alternativa IFR: $\epsilon^{*} \geq Z_{\alpha}$.
- Alternativa DFR: $\epsilon^{*} \leq - Z_{\alpha}$.
- Alternativa IFR o DFR: $|\epsilon^{*}| \geq Z_{\frac{\alpha}{2}}$.

# Methylmercury poisoning: Test a una cola con alternativa IFR

Se quiere testear la hipótesis nula de exponencialidad (tasa $r(x)$ constante) contra la alternativa de tasa creciente, debido a que se sospecha que cuantos más días pasan más crece la probabilidad de que los peces mueran.

-  $H_0: F$ es exponencial 

-  $H_1: F$ es IFR (y por lo tanto no exponencial)

# Methylmercury poisoning: Test a una cola con alternativa IFR

```{r}
datos <- sort(c(42, 43, 51, 61, 66, 69, 71, 81, 82, 82))
datos_o <- c(0, datos[-length(datos)])
si <- vector('double', length = length(datos))
for (i in 1:length(datos)){
      if (i==1){
            si[i] <- (length(datos) - i + 1) * 
                  (datos[i] - datos_o[i])
      } else {
            si[i] <- (length(datos) - i + 1) * 
                  (datos[i] - datos_o[i]) + si[i-1]
      }
}
suma_si <- sum(si[-length(si)])
sn <- si[length(si)]
epsilon <- suma_si / sn
```

# Methylmercury poisoning: Test a una cola con alternativa IFR

El estadístico de prueba $\epsilon$ toma el valor `r epsilon`. Buscamos en la tabla para $n=10$ y encontramos $P<0.005$ por lo cual existe evidencia empírica en contra de la hipótesis nula de exponencialidad y a favor de la alternativa IFR.

Observe que $n \geq 9$ por lo cual "podemos" usar la aproximación para muestras grandes de la distribuciuón del estadístico de prueba.

```{r}
en <- (epsilon-(length(datos)-1)/2)/sqrt((length(datos)-1)/12)
```

$en$ toma el valor `r en` por lo que $P < 0.002$ y por lo tanto la aproximación para muestras grandes confirma la evidencia contra $H_0$ y a favor de \textit{\textbf{age deteroration}}.

# The increasing failure rate average class (IFRA)

$r(x)$ la tasa de fallo puede tener una tendencia creciente pero no ser necesariamente no decreciente, como es requerido en la clase IFR.

La clase IFRA considera el caso en el que $r(x)$ fluctúa, por ejemplo, debido a variaiones estacionales. En aplicaciones médicas una tasa $r(x)$ inicialmente creciente puede decrecer debido a una intervención médica.

De forma análoga definimos la clase \textbf{DFRA} (decreasing failure rate average).

## Observe que:

- $IFR \subset IFRA$
- $DFR \subset DFRA$

# Distribución exponencial

\textbf{Observación}

Las distribución exponencial pertenece a la clase $IFR$ y también a la $DFR$ y a su vez es la única distribución que es $IFR$ y $DFR$ a la vez. 

Lo mismo para las clases $IFRA$ y $DFRA$.